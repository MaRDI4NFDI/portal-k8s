apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: crowdsec
  namespace: crowdsec
spec:
  interval: 30m
  releaseName: crowdsec
  chart:
    spec:
      chart: crowdsec
      version: "0.20.1"
      sourceRef:
        kind: HelmRepository
        name: crowdsec
        namespace: flux-system
      interval: 12h
  install:
    createNamespace: false
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    container_runtime: containerd
    lapi:
      replicas: 1
      resources:
        limits:
          cpu: 1000m
          memory: 512Mi
        requests:
          cpu: 100m
          memory: 256Mi
      persistentVolume:
        data:
          enabled: true
          size: 2Gi
      env:
        - name: COLLECTIONS
          value: "crowdsecurity/traefik crowdsecurity/http-cve crowdsecurity/whitelist-good-actors"
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true

    agent:
      enabled: true
      replicas: 1
      resources:
        limits:
          memory: 256Mi
        requests:
          cpu: 100m
          memory: 128Mi
      
      acquisition:
        - namespace: staging
          podName: staging-traefik-*
          program: traefik
          poll_without_inotify: true
        - namespace: production
          podName: traefik-*
          program: traefik
          poll_without_inotify: true
      
      env:
        - name: SCENARIOS
          value: "crowdsecurity/http-crawl-non_statics crowdsecurity/http-probing crowdsecurity/http-sensitive-files crowdsecurity/http-bad-user-agent"
        - name: PARSERS
          value: "crowdsecurity/traefik-logs"
        - name: COLLECTIONS
          value: "crowdsecurity/traefik"
        - name: LOG_LEVEL
          value: "info"
      
      metrics:
        enabled: true
        serviceMonitor:
          enabled: false

    config:
      scenarios:
        mediawiki-special-page-abuse.yaml: |
          type: leaky
          name: myorg/mediawiki-special-page-abuse
          description: "Detects aggressive crawling of MediaWiki special pages and export formats"
          filter: |
            evt.Meta.http_path matches "^/wiki/Special:(WhatLinksHere|RecentChangesLinked|EntityData|EntityPage|EntityUsage|Contributions|Export)" or
            evt.Meta.http_path contains ".n3" or
            evt.Meta.http_path contains ".nt" or
            evt.Meta.http_path contains ".rdf" or
            evt.Meta.http_path contains ".ttl" or
            evt.Meta.http_path contains ".json" or
            evt.Meta.http_path matches ".*[?&]action=(info|purge|history|raw)"
          leakspeed: "10s"
          capacity: 5
          groupby: evt.Meta.source_ip
          labels:
            service: mediawiki
            type: special-page-abuse
            remediation: true
          blackhole: 4h

        mediawiki-recent-changes-abuse.yaml: |
          type: leaky
          name: myorg/mediawiki-recent-changes-abuse
          description: "Detects aggressive crawling of Recent changes"
          filter: evt.Meta.http_path matches "^/wiki/Special:RecentChanges"
          leakspeed: "1s"
          capacity: 10
          groupby: evt.Meta.source_ip
          labels:
            service: mediawiki
            type: special-page-abuse
            remediation: true
          blackhole: 4h
        
        mediawiki-diff-abuse.yaml: |
          type: leaky
          name: myorg/mediawiki-diff-abuse
          description: "Detects bots crawling MediaWiki diffs, old revisions, and related pages"
          filter: evt.Meta.http_path matches ".*[?&](oldid=|diff=|curid=)"
          leakspeed: "5s"
          capacity: 6
          groupby: evt.Meta.source_ip
          labels:
            service: mediawiki
            type: diff-abuse
            remediation: true
          blackhole: 4h

        mediawiki-talk-page-abuse.yaml: |
          type: leaky
          name: myorg/mediawiki-talk-page-abuse
          description: "Detects rapid crawling of talk pages"
          filter: |
            evt.Meta.http_path matches "^/wiki/[^/]+_talk:"
          leakspeed: "5s"
          capacity: 6
          groupby: evt.Meta.source_ip
          labels:
            service: mediawiki
            type: talk-page-abuse
            remediation: true
          blackhole: 4h

        mediawiki-login-crawl.yaml: |
          type: leaky
          name: myorg/mediawiki-login-crawl
          description: "Detects bots systematically crawling login pages"
          filter: evt.Meta.http_path matches ".*title=Special:UserLogin"
          leakspeed: "10s"
          capacity: 5
          groupby: evt.Meta.source_ip
          labels:
            service: mediawiki
            type: login-crawl
            remediation: true
          blackhole: 4h

        mediawiki-abusive-crawlers.yaml: |
          type: leaky
          name: myorg/mediawiki-abusive-crawlers
          description: "Blocks known abusive crawlers"
          filter: evt.Meta.http_user_agent matches "(meta-externalagent|Sogou web spider|Bytespider)"
          leakspeed: "10s"
          capacity: 1
          groupby: evt.Meta.source_ip
          labels:
            service: mediawiki
            type: abusive-crawler
            remediation: true
          blackhole: 4h
        
        mediawiki-talk-404-abuse.yaml: |
          type: leaky
          name: myorg/mediawiki-talk-404-abuse
          description: "Detects bots hitting non-existent talk pages"
          filter: |
            evt.Meta.http_path matches "_talk:" and
            evt.Meta.http_status == "404"
          leakspeed: "10s"
          capacity: 2
          groupby: evt.Meta.source_ip
          labels:
            service: mediawiki
            type: talk-404-abuse
            remediation: true
          blackhole: 4h

      config.yaml.local: |
        api:
          server:
            auto_registration:
              enabled: true
              token: "${REGISTRATION_TOKEN}"
              allowed_ranges:
                - "127.0.0.1/32"
                - "192.168.0.0/16"
                - "10.0.0.0/8"
                - "172.16.0.0/12"
            online_client:
              sharing: false
              pull:
                community: true
                blocklists: true
      console.yaml: |
        share_manual_decisions: false
        share_custom: false
        share_tainted: false
        share_context: false

    appsec:
      enabled: true
      replicas: 1
      resources:
        limits:
          memory: 256Mi
          cpu: 500m
        requests:
          cpu: 100m
          memory: 128Mi
      
      acquisitions:
        - source: appsec
          listen_addr: "0.0.0.0:7422"
          path: /
          appsec_config: myorg/block-old-browsers
          labels:
            type: appsec
      
      env:
        - name: COLLECTIONS
          value: "crowdsecurity/appsec-virtual-patching"
      
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true

      configs:
        block-old-browsers.yaml: |
          name: myorg/block-old-browsers
          default_remediation: ban
          inband_rules:
            - myorg/outdated-chrome-rule

      rules:
        outdated-chrome-rule.yaml: |
          name: myorg/outdated-chrome-rule
          description: "Block requests from outdated Chrome versions (1-120), excluding known search bots"
          rules:
            - and:
              - zones:
                  - HEADERS
                variables:
                  - user-agent
                match:
                  type: regex
                  value: "Chrome/([1-9]|[1-9][0-9]|10[0-9]|11[0-9]|120)\\."
              - zones:
                  - HEADERS
                variables:
                  - user-agent
                match:
                  type: regex
                  value: "(?i)(googlebot|bingbot)"
                  not: true
          labels:
            type: exploit
            service: http
            confidence: 3

    image:
      repository: crowdsecurity/crowdsec
      pullPolicy: IfNotPresent