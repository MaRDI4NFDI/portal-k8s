apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: prefect-server
spec:
  chart:
    spec:
      version: "2025.10.23195705"
  values:
    server:
      basicAuth:
        enabled: true
        existingSecret: "prefect-server-auth"

      loggingLevel: DEBUG

      uiConfig:
        prefectUiApiUrl: "http://prefect-mardi.zib.de/api"
        prefectUiStaticDirectory: "/ui_build"
            
      resources:
        requests:
          cpu: 500m
          memory: 512Mi
        limits:
          cpu: "1"
          memory: 1Gi
      
      livenessProbe:
        enabled: true
      
      readinessProbe:
        enabled: true
          
    serviceAccount:
      create: true
      annotations: {}
    
    service:
      type: ClusterIP
      port: 4200
      targetPort: 4200
    
    ingress:
      enabled: true
      className: "nginx"
      host:
        hostname: prefect-mardi.zib.de
        path: /
        pathType: Prefix
      annotations:
        nginx.ingress.kubernetes.io/whitelist-source-range: 130.73.0.0/16
      servicePort: server-svc-port

    secret:
      create: false
    
    postgresql:
      enabled: true      
      auth:
        existingSecret: "prefect-server-postgresql"
      primary:
        persistence:
          enabled: true
          size: 20Gi
        resources:
          requests:
            cpu: 250m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi 
      image:
        repository: bitnamilegacy/postgresql
        tag: 14.13.0    